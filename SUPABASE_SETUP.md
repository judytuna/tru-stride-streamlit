# Supabase Migration Setup Guide

## 1. Create Supabase Project

1. Go to [supabase.com](https://supabase.com) and create a free account
2. Create a new project
3. Wait for the project to be ready (~2 minutes)

## 2. Set Up Database Tables

Go to the SQL Editor in your Supabase dashboard and run this SQL:

```sql
-- Profiles table (extends Supabase auth.users)
CREATE TABLE profiles (
    id UUID REFERENCES auth.users ON DELETE CASCADE,
    username TEXT UNIQUE,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (id)
);

-- Videos table
CREATE TABLE videos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users ON DELETE CASCADE,
    filename TEXT,
    upload_date TIMESTAMP DEFAULT NOW(),
    analysis_results JSONB
);

-- Enable Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;

-- Policies for profiles
CREATE POLICY "Users can read own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can insert own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- Policies for videos
CREATE POLICY "Users can read own videos" ON videos FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own videos" ON videos FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Admin policies (admins can read all data)
CREATE POLICY "Admins can read all profiles" ON profiles FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND is_admin = TRUE)
);
CREATE POLICY "Admins can read all videos" ON videos FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND is_admin = TRUE)
);
CREATE POLICY "Admins can update profiles" ON profiles FOR UPDATE USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND is_admin = TRUE)
);

-- Function to automatically create profile when user signs up
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, username, is_admin)
    VALUES (
        new.id,
        COALESCE(new.raw_user_meta_data->>'username', split_part(new.email, '@', 1)),
        COALESCE((new.raw_user_meta_data->>'is_admin')::boolean, false)
    );
    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create profile on signup
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
```

## 3. Get Your Credentials

1. Go to Settings → API in your Supabase dashboard
2. Copy these values:
   - **Project URL** (looks like: `https://xxxxx.supabase.co`)
   - **Anon public key** (the `anon` `public` key - NOT the service role key)

## 4. Update Streamlit Secrets

In your Streamlit Cloud app settings, go to Secrets and add:

```toml
# Supabase credentials
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_ANON_KEY = "your-anon-key-here"

# Admin user password (minimum 6 characters)
ADMIN_PASSWORD = "your_secure_admin_password123"
```

## 5. Deploy

Push your changes to GitHub. Streamlit Cloud will automatically redeploy with the new Supabase integration.

## 6. First Login

After deployment:
1. The app will automatically create the admin user if the environment variable is set
2. Login with email instead of username:
   - Admin: `admin@example.com` with your `ADMIN_PASSWORD`
3. Other users (like epona01) can create their own accounts via the normal signup process

## Benefits of This Migration

✅ **Persistent data** - No more database loss when app restarts
✅ **Proper authentication** - Secure password handling via Supabase Auth
✅ **Email verification** - Built-in email verification for new users
✅ **Scalable** - Can handle many more users than SQLite
✅ **Backup & recovery** - Automatic backups via Supabase

## Troubleshooting

- **Missing tables**: Make sure you ran the SQL setup in step 2
- **Auth errors**: Check that your `SUPABASE_URL` and `SUPABASE_ANON_KEY` are correct
- **Admin creation fails**: Ensure passwords are at least 6 characters long
- **Login issues**: Use email addresses, not usernames for login

...ran the SQL, updated Streamlit secrets

> done

⏺ Excellent! Now let's deploy and test the migration.

  Step 5: Deploy the Changes

  1. Commit and push your changes to GitHub:
  git add .
  git commit -m "Migrate from SQLite to Supabase for persistent storage"
  git push
  2. Streamlit Cloud will automatically redeploy - you should see the deployment starting in your Streamlit dashboard
  3. Wait for deployment - it usually takes 1-2 minutes

  Step 6: Test the Migration

  Once deployed, test these key features:

  1. Admin auto-creation: You should see a toast notification that the admin user was created
  2. Admin login: Try logging in with:
    - Email: admin@example.com
    - Password: Your ADMIN_PASSWORD from secrets
  3. User signup: Try creating a new regular user account
  4. Video upload: Test uploading and analyzing a video
  5. Persistence: Try refreshing the page - your login should persist

  Let me know:
  - If the deployment completes successfully
  - If you can see the admin user creation notification
  - If you can log in as admin

  Go ahead and push the changes to GitHub!

