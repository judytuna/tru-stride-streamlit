# Supabase Migration Setup Guide

## 1. Create Supabase Project

1. Go to [supabase.com](https://supabase.com) and create a free account
2. Create a new project
3. Wait for the project to be ready (~2 minutes)

## 2. Set Up Database Tables

Go to the SQL Editor in your Supabase dashboard and run this SQL:

```sql
-- Profiles table (extends Supabase auth.users)
CREATE TABLE profiles (
    id UUID REFERENCES auth.users ON DELETE CASCADE,
    username TEXT UNIQUE,
    is_admin BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (id)
);

-- Videos table
CREATE TABLE videos (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users ON DELETE CASCADE,
    filename TEXT,
    upload_date TIMESTAMP DEFAULT NOW(),
    analysis_results JSONB
);

-- Enable Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE videos ENABLE ROW LEVEL SECURITY;

-- Policies for profiles
CREATE POLICY "Users can read own profile" ON profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can insert own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- Policies for videos
CREATE POLICY "Users can read own videos" ON videos FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own videos" ON videos FOR INSERT WITH CHECK (auth.uid() = user_id);

-- NOTE: Admin policies are NOT needed - admin dashboard uses service role key to bypass RLS
-- This prevents infinite recursion issues while maintaining security

-- Function to automatically create profile when user signs up
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.profiles (id, username, is_admin)
    VALUES (
        new.id,
        COALESCE(new.raw_user_meta_data->>'username', split_part(new.email, '@', 1)),
        COALESCE((new.raw_user_meta_data->>'is_admin')::boolean, false)
    );
    RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create profile on signup
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();
```

## 3. Get Your Credentials

1. Go to Settings ‚Üí API in your Supabase dashboard
2. Copy these values:
   - **Project URL** (looks like: `https://xxxxx.supabase.co`)
   - **Anon public key** (the `anon` `public` key)
   - **Service role key** (the `service_role` key - keep this secret!)

## 4. Update Streamlit Secrets

In your Streamlit Cloud app settings, go to Secrets and add:

```toml
# Supabase credentials
SUPABASE_URL = "https://your-project.supabase.co"
SUPABASE_ANON_KEY = "your-anon-key-here"
SUPABASE_SERVICE_ROLE_KEY = "your-service-role-key-here"
```

‚ö†Ô∏è **Important**: The service role key bypasses ALL security policies - keep it secret!

## 5. Deploy

Push your changes to GitHub. Streamlit Cloud will automatically redeploy with the new Supabase integration.

## 6. First Use

After deployment:
1. **Create your first admin user** by signing up normally through the app
2. **Manually promote to admin** in Supabase dashboard:
   - Go to Table Editor ‚Üí profiles table
   - Find your user record
   - Set `is_admin = true`
3. **Other users** can create accounts via normal signup process

## Benefits of This Migration

‚úÖ **Persistent data** - No more database loss when app restarts
‚úÖ **Secure authentication** - Supabase Auth with email verification
‚úÖ **Row Level Security** - Users can only access their own data
‚úÖ **Admin dashboard** - Full analytics via service role key
‚úÖ **Session isolation** - Independent authentication per browser
‚úÖ **Scalable** - Cloud PostgreSQL database with automatic backups

## Troubleshooting

- **Missing tables**: Make sure you ran the SQL setup in step 2
- **Auth errors**: Check that your `SUPABASE_URL` and `SUPABASE_ANON_KEY` are correct  
- **Admin dashboard empty**: Ensure `SUPABASE_SERVICE_ROLE_KEY` is set correctly
- **RLS blocking access**: Users can only see their own data - this is normal behavior
- **Session issues**: Try logging out and back in to refresh the session
- **Email verification**: New users must verify their email before they can login

## Security Notes

üîí **Row Level Security (RLS)** is enabled:
- Regular users can only access their own profiles and videos
- Admin users see all data via service role key in admin dashboard
- Cross-browser sessions are completely isolated

üîë **Key Management**:
- `SUPABASE_ANON_KEY`: Safe to expose, used for regular user operations
- `SUPABASE_SERVICE_ROLE_KEY`: **Never expose** - bypasses all security policies

